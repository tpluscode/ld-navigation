<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ld-link-tests</title>
    <script src="../bower_components/webcomponentsjs/webcomponents.min.js"></script>
    <script src="../bower_components/web-component-tester/browser.js"></script>
    <script src="event-helper.js"></script>
    <link rel="import" href="../ld-navigation.html">
</head>
<body>
    <ld-navigator></ld-navigator>
    <test-fixture id="no-resource-url">
        <template>
            <ld-link></ld-link>
        </template>
    </test-fixture>
    <test-fixture id="anchor-child">
        <template>
            <ld-link resource-url="http://example.com/some/path">
                <a>The link</a>
            </ld-link>
        </template>
    </test-fixture>
    <test-fixture id="no-link-child">
        <template>
            <ld-link resource-url="http://example.com/some/path">
                Simple text link
            </ld-link>
        </template>
    </test-fixture>

    <script>
        var ldLink, ldNavigator;

        describe('<ld-link>', function () {

            beforeEach(function () {
                ldLink = fixture('no-resource-url');
            });

            it('renders no link', function () {
                assert.isNull(ldLink.querySelector('a'));
            });

        });

        describe('<ld-link resource-url="http://example.com/some/path"><a/></ld-link>', function () {

            beforeEach(function () {
                ldNavigator = document.querySelector('ld-navigator');
            });

            describe('without base', function(){

                beforeEach(function () {
                    ldNavigator.base = '';
                    ldLink = fixture('anchor-child');
                });

                it('sets absolute href link', function () {

                    assert.equal(ldLink.querySelector('a').getAttribute('href'), '/http://example.com/some/path');
                });

                it('when anchor clicked, triggers navigation', function(done) {

                    testHandler(window, 'ld-navigated', function(e) {
                        assert.equal(e.detail.resourceUrl, ldLink.resourceUrl);
                        done();
                    });

                    ldLink.querySelector('a').click();
                });

                it('when clicked, does nothing', function(done) {

                    var handler = function() {
                        done(new Error('navigation shouldn\'t have happened'));
                    };
                    window.addEventListener('ld-navigated', handler);

                    ldLink.click();

                    window.setTimeout(function() {
                      window.removeEventListener('ld-navigated', handler);
                      done();
                    }, 50);
                });
            });

            describe('with base', function() {
                beforeEach(function () {
                    ldNavigator.base = 'http://example.com';
                    ldLink = fixture('anchor-child');
                });

                it('sets relative href link', function () {

                    assert.equal(ldLink.querySelector('a').getAttribute('href'), '/some/path');
                });
            });

            describe('with base and client-base-path', function() {
                beforeEach(function () {
                    ldNavigator.base = 'http://example.com';
                    ldNavigator.clientBasePath = 'some/base';
                    ldLink = fixture('anchor-child');
                });

                it('sets relative href link with client base prepended', function () {

                    assert.equal(ldLink.querySelector('a').getAttribute('href'), '/some/base/some/path');
                });
            });

            describe('without base, using hash fragment', function(){

                beforeEach(function () {
                    ldNavigator.base = '';
                    ldNavigator.useHashFragment = true;
                    ldLink = fixture('anchor-child');
                });

                it('sets absolute href link', function () {

                    assert.equal(ldLink.querySelector('a').getAttribute('href'), '#http://example.com/some/path');
                });
            });

            describe('with base, using hash fragment', function() {
                beforeEach(function () {
                    ldNavigator.base = 'http://example.com';
                    ldNavigator.useHashFragment = true;
                    ldLink = fixture('anchor-child');
                });

                it('sets relative href link', function () {

                    assert.equal(ldLink.querySelector('a').getAttribute('href'), '#/some/path');
                });
            });

            describe('with base and client-base-path, using hash fragment', function() {
                beforeEach(function () {
                    ldNavigator.base = 'http://example.com';
                    ldNavigator.clientBasePath = 'some/base';
                    ldNavigator.useHashFragment = true;
                    ldLink = fixture('anchor-child');
                });

                it('sets relative href link', function () {

                    assert.equal(ldLink.querySelector('a').getAttribute('href'), '#/some/path');
                });
            });
        });

        describe('<ld-link resource-url="http://example.com/some/path"> text </ld-link>', function () {
            beforeEach(function () {
                ldLink = fixture('no-link-child');
            });
            
            it('should not render anchor', function() {
                assert.isNull(ldLink.querySelector('a'));
            });

            it('when clicked, triggers navigation', function(done) {

                testHandler(window, 'ld-navigated', function(e) {
                    assert.equal(e.detail.resourceUrl, ldLink.resourceUrl);
                    done();
                });

                ldLink.click();
            });
        });

    </script>
</body>
</html>