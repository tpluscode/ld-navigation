<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ld-link-tests</title>
    <script src="../bower_components/webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../bower_components/web-component-tester/browser.js"></script>
    <script src="event-helper.js"></script>
    <link rel="import" href="../ld-navigation.html">
</head>
<body>
    <test-fixture id="EmptyNavigator">
        <template>
            <ld-navigator></ld-navigator>
        </template>
    </test-fixture>

    <test-fixture id="NavigatorWithBase">
        <template>
            <ld-navigator base="http://example.com"></ld-navigator>
        </template>
    </test-fixture>

    <test-fixture id="NavigatorWithClientBase">
        <template>
            <ld-navigator base="http://example.com" client-base-path="components/html5-history/test"></ld-navigator>
        </template>
    </test-fixture>

    <script>
        var ldNavigator;

        describe('<ld-navigator>', function(){

            beforeEach(function(){
                ldNavigator = fixture('EmptyNavigator');
            });

            it('doesn\'t set attribute when setting base URL property', function(){
                ldNavigator.base = 'http://example.org/';
                assert.isNull(ldNavigator.getAttribute('base'));
            });

            it('should change resource url when ld-navigation occurs', function(done) {

                ldNavigator.addEventListener('resource-url-changed', function(e) {
                    assert.equal(e.detail.value, 'http://example.org/current/resource');
                    done();
                });

                LdNavigation.Helpers.fireNavigation(document, 'http://example.org/current/resource');
            });

            it('should not change resource url when it is same as current', function(done) {

                var handled;
                LdNavigation.Helpers.fireNavigation(document, 'http://example.org/current/resource');

                ldNavigator.addEventListener('resource-url-changed', function(e) {
                    handled = true;
                    done(new Error('event shouldn\'t have happened'));
                });

                LdNavigation.Helpers.fireNavigation(document, 'http://example.org/current/resource');

                window.setTimeout(function() {
                    if(!handled)
                        done();
                }, 200);
            });

            it('has resource URL set to relative document path', function() {
               window.history.pushState({}, '', '/test/ld-navigator-tests.html');
               assert.isTrue(new RegExp('^/.*test/ld-navigator-tests.html').test(ldNavigator.resourceUrl));
            });

          it('sets property when setting base attribute', function() {
            ldNavigator.setAttribute('base', 'http://example.org');
            assert.equal(ldNavigator.base, 'http://example.org');
          });

          it('sets property when setting client-base-path attribute', function() {
            ldNavigator.setAttribute('client-base-path', 'my/test');
            assert.equal(ldNavigator.clientBasePath, 'my/test');
          });

          it('should remove trailing slash from base URL', function(){
            ldNavigator.setAttribute('base', 'http://example.org/');

            assert.equal(ldNavigator.base, 'http://example.org');
          });
        });

        describe('<ld-navigator base="http://example.com">', function(){

            beforeEach(function(){
                ldNavigator = fixture('NavigatorWithBase');
            });

            it('has resource URL set to absolute document path', function() {
                window.history.pushState({}, '', '/some/client/path/ld-navigator-tests.html');

                assert.equal(ldNavigator.resourceUrl, 'http://example.com/some/client/path/ld-navigator-tests.html');
            });
        });

        describe('<ld-navigator base="http://example.com" client-base-path="components/html5-history/test">', function(){

            beforeEach(function(){
                ldNavigator = fixture('NavigatorWithClientBase');
            });

            it('has resource URL without base client path', function() {
                window.history.pushState({}, '', '/components/html5-history/test/ld-navigator-tests.html');

                assert.equal(ldNavigator.resourceUrl, 'http://example.com/ld-navigator-tests.html');
            });
        });

    </script>
</body>
</html>
