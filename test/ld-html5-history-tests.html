<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <script src="../bower_components/webcomponentsjs/webcomponents.min.js"></script>
    <script src="../bower_components/web-component-tester/browser.js"></script>
    <link rel="import" href="../ld-navigation.html">
</head>
<body>
<test-fixture id="EmptyHistoryElementFixture">
    <template>
        <ld-html5-history></ld-html5-history>
    </template>
</test-fixture>

<test-fixture id="HistoryElementWithBaseUrlFixture">
    <template>
        <!-- fails on IE, because script inside <template> aren't inert -->
        <script type="application/javascript">
            LdNavigation.Context.base = 'http://example.org';
        </script>

        <ld-html5-history></ld-html5-history>
    </template>
</test-fixture>

<test-fixture id="HistoryElementUsingHash">
    <template>
        <ld-html5-history use-hash-fragment></ld-html5-history>
    </template>
</test-fixture>

<script>
    var elem;

    describe('<ld-html5-history>', function () {

        var handler;
        beforeEach(function(){
            elem = fixture('EmptyHistoryElementFixture');
        });

        it('should push absolute URL state when ld-navigated event occurs', function(done) {

            handler = function() {
                assert.equal(location.pathname, '/http://example.org/some/path');
                done();
            };

            window.addEventListener('ld-navigated', handler);

            LdNavigation.Helpers.fireNavigation(document, 'http://example.org/some/path');
        });

        it('should trigger navigation on popstate event', function(done) {

            LdNavigation.Helpers.fireNavigation(document, 'http://example.org/initial/path');
            LdNavigation.Helpers.fireNavigation(document, 'http://example.org/next/path');

            handler = function(e) {
                assert.equal(e.detail.resourceUrl, 'http://example.org/initial/path');
                done();
            };

            window.addEventListener('ld-navigated', handler);
            history.back();
        });

        afterEach(function () {
            window.removeEventListener('ld-navigated', handler);
        });

    });

    describe('<ld-html5-history> with base', function () {

        var handler;

        beforeEach(function(){
            elem = fixture('HistoryElementWithBaseUrlFixture')[1];
        });

        it('should push relative URL state when ld-navigated event occurs', function(done) {

            handler = function() {
                assert.equal(location.pathname, '/some/other/path');
                done();
            };

            window.addEventListener('ld-navigated', handler);

            LdNavigation.Helpers.fireNavigation(document, 'http://example.org/some/other/path');
        });

        afterEach(function () {
            window.removeEventListener('ld-navigated', handler);
        });

    });

    describe('<ld-html5-history use-hash-fragment>', function() {

        var handler;
        beforeEach(function(){
            elem = fixture('HistoryElementUsingHash');
        });

        it('should set URL hash when ld-navigated event occurs', function(done) {

            handler = function() {
                assert.equal(location.hash, '#http://example.org/hash/path');
                done();
            };

            window.addEventListener('ld-navigated', handler);

            LdNavigation.Helpers.fireNavigation(document, 'http://example.org/hash/path');
        });

        it('should trigger navigation on hashchange event', function(done) {

            LdNavigation.Helpers.fireNavigation(document, 'http://example.org/initial/path');
            LdNavigation.Helpers.fireNavigation(document, 'http://example.org/next/path');

            handler = function(e) {
                assert.equal(e.detail.resourceUrl, 'http://example.org/initial/path');
                done();
            };

            window.addEventListener('ld-navigated', handler);
            history.back();
        });

        afterEach(function () {
            window.removeEventListener('ld-navigated', handler);
        });
    });
</script>
</body>
</html>