<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <script src="../bower_components/webcomponentsjs/webcomponents.min.js"></script>
    <link rel="import" href="../bower_components/app-layout/app-layout.html"/>
    <link rel="import" href="../bower_components/paper-listbox/paper-listbox.html"/>
    <link rel="import" href="../bower_components/paper-item/paper-item.html"/>
    <link rel="import" href="../bower_components/paper-card/paper-card.html"/>
    <link rel="import" href="../bower_components/paper-toast/paper-toast.html"/>
    <link rel="import" href="../bower_components/paper-button/paper-button.html"/>
    <link rel="import" href="../bower_components/iron-pages/iron-pages.html"/>
    <link rel="import" href="../bower_components/marked-element/marked-element.html"/>
    <link rel="import" href="../bower_components/prism-element/prism-highlighter.html" />
    <link rel="import" href="../bower_components/upper88-title/upper88-title.html" />
    <link rel="import" href="../ld-navigation.html"/>

    <link rel="stylesheet" href="../bower_components/github-fork-ribbon-css/gh-fork-ribbon.css" />

    <!-- Start Single Page Apps for GitHub Pages -->
    <script type="text/javascript">
        /////////////////////////////////////////////////////////////////////////
        // Single Page Apps for GitHub Pages
        // https://github.com/rafrex/spa-github-pages
        // Copyright (c) 2016 Rafael Pedicini, licensed under the MIT License
        // ----------------------------------------------------------------------
        // This script checks to see if a redirect is present in the query string
        // and converts it back into the correct url and adds it to the
        // browser's history using window.history.replaceState(...),
        // which won't cause the browser to attempt to load the new url.
        // When the single page app is loaded further down in this file,
        // the correct url will be waiting in the browser's history for
        // the single page app to route accordingly.
        /////////////////////////////////////////////////////////////////////////
        (function(l) {
            if (l.search) {
                var q = {};
                l.search.slice(1).split('&').forEach(function(v) {
                    var a = v.split('=');
                    q[a[0]] = a.slice(1).join('=').replace(/~and~/g, '&');
                });
                if (q.p !== undefined) {
                    window.history.replaceState(null, null,
                        l.pathname.slice(0, -1) + (q.p || '') +
                        (q.q ? ('?' + q.q) : '') +
                        l.hash
                    );
                }
            }
        }(window.location))
    </script>
    <!-- End Single Page Apps for GitHub Pages -->

    <style>
        a {
            text-decoration: none;
        }

        paper-item a {
            line-height: 40px;
            display: block;
            height: 40px;
            width: 100%;
        }

        paper-card {
            margin: 10px;
        }

        paper-toast {
            width: 100%;
        }

        paper-toast a {
            color: white;
            text-decoration: underline;
        }

        app-drawer-layout > div {
            max-width: 900px;
        }
    </style>
</head>
<body>

<template id="app" is="dom-bind">
    <ld-navigator resource-url="{{resourceUrl}}"
                  on-resource-url-changed="openToast"
                  base="{{base}}/"
                  client-base-path="ld-navigation"
                  use-hash-fragment$="[[useHashFragment]]"></ld-navigator>

    <prism-highlighter></prism-highlighter>

    <upper88-title hidden value$="[[getTitle(selectedItem)]] - ld-navigation - web components for simple client side routing"></upper88-title>

    <paper-toast id="toast">
        You just navigated to [[resourceUrl]]. <ld-link resource-url="{{base}}/events"><a>How do I know?</a></ld-link>
    </paper-toast>

    <app-drawer-layout>
        <app-drawer>
            <paper-listbox attr-for-selected="data-url" selected="[[resourceUrl]]" on-iron-select="menuNavigate">

                <paper-item data-url="http://example.com/using-absolute-paths-as-state">
                    <ld-link resource-url="http://example.com/using-absolute-paths-as-state">Unmapped base URL</ld-link>
                </paper-item>

                <paper-item data-url="{{base}}/base-path-mapping">
                    <ld-link resource-url="{{base}}/base-path-mapping">Mapped base URL</ld-link>
                </paper-item>

                <paper-item data-url="{{base}}/bookmark-ld-link">
                    <ld-link resource-url="{{base}}/bookmark-ld-link">Bookmarkable ld-link</ld-link>
                </paper-item>

                <paper-item data-url="{{base}}/base-state-path">
                    <ld-link resource-url="{{base}}/base-state-path">Base state path</ld-link>
                </paper-item>

                <paper-item data-url="{{base}}/dynamic-navigation" on-tap="navigate">
                    Dynamic navigation
                </paper-item>

                <paper-item data-url="{{base}}/events">
                    <ld-link resource-url="{{base}}/events">Navigation events</ld-link>
                </paper-item>

            </paper-listbox>
        </app-drawer>
        <div>
            <paper-card heading="Current resource URL is">
                <div class="card-content">
                    {{resourceUrl}}
                </div>
            </paper-card>

            <paper-card heading="Works great with Polymer" hidden$="[[!showPolymerBox(navigationCount)]]">
                <div class="card-content">
                    <div class="card-content">
                        <marked-element>
                            <div class="markdown-html"></div>
                            <script type="text/markdown">
                                Hey, sorry to intrude, but I see that you've done some clicking.
                                Now try using the [back][back] and [forward][fwd] buttons in your browser.

                                See how the menu selection updates when you move between states? This is done using Polymer's
                                declarative binding syntax

                                ``` html
                                <ld-navigator resource-url="{ {resource-url}}"></ld-navigator>

                                <paper-listbox attr-for-selected="data-url" selected="[ [resourceUrl]]"></paper-listbox>
                                ```

                                With some code, this will of course work with any DOM library because those bindings are
                                just attributes and events.

                                (Forgive invalid binding syntax, but I don't know how to display it correctly with
                                `<marked-element>`).

                                [back]: javascript:history.back()
                                [fwd]: javascript:history.forward()
                            </script>
                        </marked-element>
                    </div>
                    <div class="card-actions">
                        <paper-button on-tap="hidePolymerCard">Close</paper-button>
                    </div>
                </div>
            </paper-card>

            <iron-pages id="docsPages" attr-for-selected="data-url" selected="[[resourceUrl]]" selected-item="{{selectedItem}}" fallback-selection="not-found">
                <paper-card heading="SPA routing - Linked Data-style" data-url="{{base}}/">
                    <div class="card-content">
                        <marked-element>
                            <div class="markdown-html"></div>
                            <script type="text/markdown">
                                Welcome to sample page for the [ld-navigation][gh] repository. It contains three elements,
                                which can be used to manage the application state by tracking HTTP API's resource URLs.

                                Go ahead and click the menu elements on the left to see them in action.

                                **TL;DR;** the elements are:

                                ## `<ld-navigator>`

                                Allows you to bind and observe the resource URL, while maintaining history
                                ([HTML5 history API][history] or [hash][useHash]) and rewrites browsers URL for nicer
                                client addresses.

                                ## `<ld-link> <a/> </ld-link>`

                                Wraps anchor so that state transitions are possible

                                [gh]: https://github.com/tpluscode/ld-navigation
                                [history]: https://developer.mozilla.org/en/docs/Web/API/History
                                [useHash]: ?useHash
                            </script>
                        </marked-element>
                    </div>
                </paper-card>

                <paper-card heading="location.hash history fallback" data-url="{{base}}/?useHash">
                    <div class="card-content">
                        <marked-element>
                            <div class="markdown-html"></div>
                            <script type="text/markdown">
                                I see that you decided to try the hash fragment history. This is configured by setting an
                                attribute of the `<ld-navigator>` element.

                                ``` html
                                <ld-navigator use-hash-fragment></ld-navigator>
                                ```

                                Note that it is also set automatically if the browser doesn't support
                                [HTML5 history API](https://developer.mozilla.org/en/docs/Web/API/History)
                            </script>
                        </marked-element>
                    </div>
                </paper-card>

                <paper-card heading="Absolute URL as route" data-url="http://example.com/using-absolute-paths-as-state">
                    <div class="card-content">
                        <marked-element>
                            <div class="markdown-html"></div>
                            <script type="text/markdown">
                                By selecting the first element from the menu you triggered route change by firing the `ld-link`
                                element. It is declared as an extension of anchor:

                                ``` html
                                <ld-link resource-url="http://example.com/using-absolute-paths-as-state">Unmapped base URL</ld-link>
                                ```

                                Clicking it updates the `resourceUrl` property of `<ld-navigator>` and updates the page
                                address.

                                By default, the `<ld-navigator>` has no understanding of the structure of the addresses,
                                hence you can see the entire resource URL in the address bar.
                            </script>
                        </marked-element>
                    </div>
                </paper-card>

                <paper-card heading="Bookmarkable ld-link" data-url="{{base}}/bookmark-ld-link">
                    <div class="card-content">
                        <marked-element>
                            <div class="markdown-html"></div>
                            <script type="text/markdown">
                                The `<ld-link>` element can be used alone, and as such will not act as an ordinary link.
                                It is however possible to add a child `<a>` to it and that link tag will have the `href`
                                property set to a correct *client URL* according to the `<ld-navigator>` setup.

                                For example markup like

                                ``` html
                                <ld-navigator base="http://example.com/base"
                                              client-base-path="my-app"></ld-navigator>

                                <ld-link resource-url="http://example.com/base/bookmarkable/resource">
                                    <a>The client link</a>
                                </ld-link>
                                ```

                                Will set the link to `/my-app/bookmarkable/resource` which can be happily bookmarked in
                                the browser.
                            </script>
                        </marked-element>
                    </div>
                </paper-card>

                <paper-card heading="Relative URL as route" data-url="{{base}}/base-path-mapping">
                    <div class="card-content">
                        <marked-element>
                            <div class="markdown-html"></div>
                            <script type="text/markdown">
                                The second item in the menu on the left behaves just like the first one, but the
                                address bar now shows only part of the `resourceUrl` property. This is because it is
                                possible to set a base URL for translating resource identifiers.

                                ``` html
                                <ld-navigator base="{{base}}/"></ld-navigator>
                                ```

                                By setting the `base` property of `<ld-navigator>` any URL relative to that base will
                                be used as relative in the address bare. Note though, that the `resourceUrl` property
                                will always give you the absolute URL.
                            </script>
                        </marked-element>
                    </div>
                </paper-card>

                <paper-card heading="Base client path" data-url="{{base}}/base-state-path">
                    <div class="card-content">
                        <marked-element>
                            <div class="markdown-html"></div>
                            <script type="text/markdown">
                                A Single Page Application doesn't necessarily live in the root of your web server.
                                Such is the case with these pages which are hosted using GitHub Pages. This is important
                                with HTML5 history, because `<ld-navigator>` element will by default try to
                                push the state by replacing the entire client path.

                                To retain the base path it is possible to set the `client-base-path` attribute of
                                `<ld-navigator>`. It's value will be prepended to the routing path. The page
                                you're looking at uses it as follows:

                                ``` html
                                <ld-navigator client-base-path="ld-navigation"></ld-navigator>
                                ```

                                This way, when changing client state, the address will show for example
                                `/ld-navigation/my/resource/path` instead of just `/my/resource/path`.
                            </script>
                        </marked-element>
                    </div>
                </paper-card>

                <paper-card heading="Dynamic navigation" data-url="{{base}}/dynamic-navigation">
                    <div class="card-content">
                        <marked-element>
                            <div class="markdown-html"></div>
                            <script type="text/markdown">
                                Navigation through `<ld-navigator>` can also be done programmatially with JavaScript.

                                To do that, use the `LdNavigation.Helpers.fireNavigation` function:

                                ``` javascript
                                var newResourceUrl = 'http://api.example.com/next/resource';
                                LdNavigation.Helpers.fireNavigation(target, newResourceUrl);
                                ```

                                This is the same function which is used by `ld-link` to trigger resource URL change.
                            </script>
                        </marked-element>
                    </div>
                </paper-card>

                <paper-card heading="Navigation events" data-url="{{base}}/events">
                    <div class="card-content">
                        <marked-element>
                            <div class="markdown-html"></div>
                            <script type="text/markdown">
                                The `<ld-navigator>` element publishes a `resource-url-changed` event whenever the
                                URL changes after navigation or browser history change. It can be used for Polymer
                                databinding or with ordinary JS code.

                                ``` html
                                <ld-navigator on-resource-url-changed="handleChange"></ld-navigator>
                                ```

                                ``` javascript
                                document.querySelector('ld-navigator').addEventHandler('resource-url-changed', handleChange);
                                ```

                                There is also a bubbling event, which triggers the navigation. `<ld-navigator>`
                                listens to in on [window level](https://github.com/tpluscode/ld-navigation/blob/master/src/ld-navigator.ts#L9).

                                ``` javascript
                                window.addEventListener('ld-navigated', (e:CustomEvent) => this.resourceUrl = e.detail.resourceUrl);
                                ```
                            </script>
                        </marked-element>
                    </div>
                </paper-card>

                <paper-card heading="No documentation page here" data-url="not-found">
                    <div class="card-content">
                        <marked-element>
                            <div class="markdown-html"></div>
                            <script type="text/markdown">
                                It looks like address doesn't represent any documentation page. This is good though.

                                As you see above it is still transformed into the `resourceUrl` property. It is up to the consumer
                                application to determine whether the URL is correct. Usually it will mean trying to GET that resource
                                with an AJAX request and decide what should happen next.
                            </script>
                        </marked-element>
                    </div>
                </paper-card>
            </iron-pages>
        </div>
    </app-drawer-layout>
</template>

<a class="github-fork-ribbon" href="http://github.com/tpluscode/ld-navigation" title="Fork me on GitHub">Fork me on GitHub</a>

<script>
    var wrapperElement = document.querySelector('#app');

    wrapperElement.base = 'http://geeky.rest/navigation/v0.3.0';

    wrapperElement.navigate = function (evt) {
        LdNavigation.Helpers.fireNavigation(window, evt.target.getAttribute('data-url'));
    };

    wrapperElement.openToast = function () {
        if(!this.polymerCardHidden) {
            this.navigationCount = (this.navigationCount || 0) + 1;
        }
        this.$.toast.open();
    };

    wrapperElement.showPolymerBox = function (navigationCount) {
        return navigationCount > 3;
    };

    wrapperElement.hidePolymerCard = function() {
        this.polymerCardHidden = true;
        this.navigationCount = 0;
    };

    wrapperElement.getTitle = function(selectedItem) {
        if(selectedItem) {
            return selectedItem.heading;
        }

        return '';
    };

    wrapperElement.menuNavigate = function(e) {
        var link = e.target.selectedItem.querySelector('ld-link');

        if(link) {
          link.click();
        }
    };

    if (getParameterByName('useHash') !== null) {
        wrapperElement.useHashFragment = true;
    }

    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }
</script>
</body>
